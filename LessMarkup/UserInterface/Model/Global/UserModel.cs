/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

using System;
using System.Collections.Generic;
using System.Linq;
using LessMarkup.DataFramework.DataAccess;
using LessMarkup.Framework.Helpers;
using LessMarkup.Interfaces.Cache;
using LessMarkup.Interfaces.Data;
using LessMarkup.Interfaces.RecordModel;
using LessMarkup.Interfaces.Security;
using LessMarkup.Interfaces.Structure;
using LessMarkup.Interfaces.System;

namespace LessMarkup.UserInterface.Model.Global
{
    [RecordModel(CollectionType = typeof(Collection), TitleTextId = UserInterfaceTextIds.User)]
    public class UserModel
    {
        public class Collection : IEditableModelCollection<UserModel>
        {
            private long? _siteId;
            private readonly IDomainModelProvider _domainModelProvider;
            private readonly IUserSecurity _userSecurity;
            private readonly IChangeTracker _changeTracker;
            private readonly ISiteMapper _siteMapper;

            public Collection(IDomainModelProvider domainModelProvider, IUserSecurity userSecurity, IChangeTracker changeTracker, ISiteMapper siteMapper)
            {
                _domainModelProvider = domainModelProvider;
                _userSecurity = userSecurity;
                _changeTracker = changeTracker;
                _siteMapper = siteMapper;
            }

            private long SiteId
            {
                get
                {
                    var siteId = _siteId ?? _siteMapper.SiteId;
                    if (!siteId.HasValue)
                    {
                        throw new UnauthorizedAccessException();
                    }
                    return siteId.Value;
                }
            }

            public IQueryable<long> ReadIds(IDomainModel domainModel, string filter, bool ignoreOrder)
            {
                return RecordListHelper.GetFilterAndOrderQuery(domainModel.GetCollection<DataObjects.Security.User>().Where(u => !u.IsRemoved && u.SiteId.Value == SiteId), filter, typeof(UserModel)).Select(u => u.Id);
            }

            public int CollectionId { get { return AbstractDomainModel.GetCollectionId<DataObjects.Security.User>(); } }

            public IQueryable<UserModel> Read(IDomainModel domainModel, List<long> ids)
            {
                return domainModel.GetCollection<DataObjects.Security.User>().Where(u => !u.IsRemoved && u.SiteId.Value == SiteId && ids.Contains(u.Id)).Select(u => new UserModel
                    {
                        Email = u.Email,
                        Id = u.Id,
                        Name = u.Name,
                        IsAdministrator = u.IsAdministrator,
                        Password = "",
                        IsBlocked = u.IsBlocked,
                        EmailConfirmed = u.EmailConfirmed,
                        IsApproved = u.IsApproved,
                        IsValidated = u.IsValidated,
                        Signature = u.Signature
                    });
            }

            public bool Filtered { get { return false; } }
            public void Initialize(long? objectId, NodeAccessType nodeAccessType)
            {
                _siteId = objectId;
            }

            public UserModel CreateRecord()
            {
                return new UserModel();
            }

            public void AddRecord(UserModel record)
            {
                using (var domainModel = _domainModelProvider.CreateWithTransaction())
                {
                    var user = new DataObjects.Security.User
                    {
                        Email = record.Email,
                        Name = record.Name,
                        Registered = DateTime.UtcNow,
                        IsBlocked = false,
                        IsValidated = true,
                        IsApproved = true,
                        LastPasswordChanged = DateTime.UtcNow,
                        IsAdministrator = record.IsAdministrator,
                        SiteId = SiteId,
                        Signature = record.Signature
                    };

                    string userSalt, encodedPassword;
                    _userSecurity.ChangePassword(record.Password, out userSalt, out encodedPassword);

                    user.Password = encodedPassword;
                    user.Salt = userSalt;
                    user.PasswordAutoGenerated = false;

                    domainModel.GetCollection<DataObjects.Security.User>().Add(user);
                    domainModel.SaveChanges();

                    _changeTracker.AddChange(user, EntityChangeType.Added, domainModel);
                    domainModel.SaveChanges();

                    domainModel.CompleteTransaction();

                    user.Password = null;

                    record.Password = null;
                    record.Id = user.Id;
                }
            }

            public void UpdateRecord(UserModel record)
            {
                using (var domainModel = _domainModelProvider.CreateWithTransaction())
                {
                    var user = domainModel.GetCollection<DataObjects.Security.User>().First(u => !u.IsRemoved && u.SiteId.Value == SiteId && u.Id == record.Id);

                    user.Name = record.Name;
                    user.Email = record.Email;
                    user.IsAdministrator = record.IsAdministrator;
                    user.Signature = record.Signature;

                    if (!string.IsNullOrWhiteSpace(record.Password))
                    {
                        string userSalt, encodedPassword;
                        _userSecurity.ChangePassword(record.Password, out userSalt, out encodedPassword);

                        user.Password = encodedPassword;
                        user.Salt = userSalt;
                        user.PasswordAutoGenerated = false;
                        user.LastPasswordChanged = DateTime.UtcNow;
                    }

                    _changeTracker.AddChange(user, EntityChangeType.Updated, domainModel);
                    domainModel.SaveChanges();
                    domainModel.CompleteTransaction();

                    record.Password = null;
                }
            }

            public bool DeleteRecords(IEnumerable<long> recordIds)
            {
                using (var domainModel = _domainModelProvider.CreateWithTransaction())
                {
                    foreach (var userId in recordIds)
                    {
                        var user = domainModel.GetCollection<DataObjects.Security.User>().First(u => !u.IsRemoved && u.SiteId == SiteId && u.Id == userId);
                        domainModel.GetCollection<DataObjects.Security.User>().Remove(user);
                        _changeTracker.AddChange(user, EntityChangeType.Removed, domainModel);
                    }
                    domainModel.SaveChanges();
                    domainModel.CompleteTransaction();
                }
                return true;
            }

            public bool DeleteOnly { get { return false; } }
        }

        public long Id { get; set; }

        [Column(UserInterfaceTextIds.UserName)]
        [InputField(InputFieldType.Text, UserInterfaceTextIds.UserName, Required = true)]
        [RecordSearch]
        public string Name { get; set; }

        [Column(UserInterfaceTextIds.UserEmail)]
        [InputField(InputFieldType.Email, UserInterfaceTextIds.UserEmail, Required = true)]
        [RecordSearch]
        public string Email { get; set; }

        [InputField(InputFieldType.PasswordRepeat, UserInterfaceTextIds.Password, Required = true)]
        public string Password { get; set; }

        [Column(UserInterfaceTextIds.IsAdministrator)]
        [InputField(InputFieldType.CheckBox, UserInterfaceTextIds.IsAdministrator, DefaultValue = false)]
        public bool IsAdministrator { get; set; }

        public bool IsValidated { get; set; }

        public bool IsApproved { get; set; }

        public bool EmailConfirmed { get; set; }

        public bool IsBlocked { get; set; }

        [InputField(InputFieldType.Text, UserInterfaceTextIds.Signature)]
        [RecordSearch]
        public string Signature { get; set; }
    }
}
